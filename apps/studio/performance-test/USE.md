# Perf Self-Test HUD 使用文档

> 用途：
>  用于**虚拟滚动 / 超大文档 / 大量 DOM 场景**的自测性能分析，实时观察
>  **FPS、DOM 数量、滚动帧耗时、Long Task、内存占用**，快速判断优化是否有效。

------

## 一、如何使用

1. 打开页面（你的文档系统页面）
2. 打开 DevTools → Console
3. 粘贴整段脚本并回车
4. 右下角会出现 **Perf Self-Test HUD** 面板

> 可选（强烈推荐）：
>  在 **Elements 面板**点中你的「虚拟文档根容器」，回到 Console 点击
>  **Use $0 as container**（只统计这个容器的 DOM）

------

## 二、面板字段说明（每一项都干嘛）

### 1️⃣ FPS

**含义**：当前页面实际渲染帧率

- 60：完全丝滑
- 50～60：可接受
- < 45：开始有明显掉帧
- < 30：肉眼可见卡顿

**关注点**：

- 滚动时 FPS 是否稳定
- overscan 调大后 FPS 是否明显下降

------

### 2️⃣ Frame (ms)

**含义**：最近一帧渲染耗时（`requestAnimationFrame` 间隔）

| 数值     | 含义       |
| -------- | ---------- |
| ~16ms    | 60fps      |
| 20～25ms | 轻微卡     |
| >33ms    | 30fps 以下 |
| >50ms    | 严重掉帧   |

**关注点**：

- 滚动时是否频繁 > 16ms
- 动态高度计算是否导致抖动

------

### 3️⃣ DOM

**含义**：当前容器内 **Element 节点数量**
 （`getElementsByTagName('*')`）

这是你虚拟化最核心的指标之一。

**经验参考**（桌面端）：

- 2k～5k：很安全

- 5k～10k：需要克制样式

- > 20k：高风险区

------

### 4️⃣ DOM (deep)

**含义**：包含 text node、comment 等的**深度节点估算值**

用来判断：

- 文本密度是否过高
- span / inline 节点是否爆炸

> 如果 `DOM` 不高但 `DOM(deep)` 非常高
>  👉 说明你段落内部结构太碎了

------

### 5️⃣ LongTasks

**含义**：主线程被阻塞 **>50ms** 的任务次数
 （来自 `PerformanceObserver('longtask')`）

**这是“用户感觉卡”的直接证据**。

| 情况           | 含义                          |
| -------------- | ----------------------------- |
| 0              | 非常好                        |
| 偶尔 1～2      | 可接受                        |
| 滚动时持续增长 | 有同步重计算/GC/大批 DOM 操作 |

------

### 6️⃣ LT max (ms)

**含义**：最长的一次 Long Task 时长

- 50～80ms：刚刚能感觉到
- 100ms+：明显卡顿
- 300ms+：滚动 / 输入会“卡死一下”

------

### 7️⃣ Scroll frame (max)

**含义**：滚动触发的 **最慢一帧** 耗时

这是**虚拟列表 / 文档系统最关键指标之一**。

**重点看这个，而不是平均值**：

- < 20ms：很好

- 20～35ms：可接受

- > 50ms：滚动明显不跟手

------

### 8️⃣ Scroll avg (ms)

**含义**：滚动相关帧的平均耗时

用来判断整体负载，而不是尖峰。

------

### 9️⃣ Memory

**含义**：JS 堆内存使用情况（仅 Chrome 支持）

显示格式：

```
已用 MB / 最大限制 MB
```

**关注点**：

- 快速滚动时是否持续上涨（GC 跟不上）
- 是否在“销毁节点”后能回落

> 如果内存不回落：
>  👉 DOM 泄漏 / 缓存未释放 / 引用残留

------

### 🔟 Container

**含义**：当前统计的 DOM 根节点

- `document`：统计整个页面
- `div#xxx`：只统计你的虚拟文档区域（强烈推荐）

------

## 三、按钮说明（一个一个说清楚）

### ▶️ Pause / Resume

**暂停 / 恢复采样**

- Pause：停止 RAF、DOM、滚动统计
- Resume：继续

适合：

- 停下来观察当前状态
- 对比不同配置前后的快照

------

### ❌ X

**完全关闭 HUD**

- 停止所有监听
- 移除 DOM
- 清理全局变量

------

### 📦 Use $0 as container

**把当前 DevTools 选中的元素作为统计容器**

使用步骤：

1. 打开 Elements 面板
2. 点中你的虚拟文档根节点
3. 回到 Console 点这个按钮

**这是正确使用姿势**
 👉 否则统计到 header / sidebar / footer 会干扰判断

------

### 🌍 Whole document

**恢复统计整个页面**

一般只在：

- 排查全局问题
- 对比局部 vs 全局影响时使用

------

### 🔦 Highlight container

**高亮当前容器 1.2 秒**

防止：

- 选错节点
- 误把子节点当根节点

------

### ⏱ 5s sample

**启动 5 秒采样窗口（重点功能）**

- 在接下来 5 秒内：
  - 记录 FPS min / avg / max
  - 记录 LongTask 总数 & 总耗时
  - 记录滚动帧 avg / max
  - 记录 DOM 最大值
- 结束后 **自动在 Console 输出总结报告**

📌 使用建议：

- 点击后立刻疯狂滚动、跳转、搜索
- 用来对比「优化前 / 优化后」

------

### 📜 Log: on / off

**每秒在 Console 打印一行性能日志**

适合：

- 录屏
- 远程排查
- 和其他指标工具对齐时间轴

------

## 四、Console API（高级用法）

脚本会暴露一个全局对象：

```
window.__PerfHUD__
```

### API 列表

```
__PerfHUD__.setContainer(el)   // 手动设置容器
__PerfHUD__.setContainer(null) // 恢复 document

__PerfHUD__.sample(8000)       // 自定义采样时长（ms）

__PerfHUD__.stop()             // 停止并销毁 HUD
```

------

## 五、如何用它验证你的虚拟文档优化（推荐流程）

1. **锁定容器**
   - Use $0 as container
2. **基线测试**
   - overscan = 当前值
   - 点 `5s sample` → 疯狂滚动
3. **只改一个变量**
   - overscan ±
   - 是否复用 DOM
   - 是否合并 span
   - 是否延迟测高
4. **再 sample**
   - 对比：
     - Scroll frame max
     - LongTasks 数量
     - DOM max

👉 **Scroll frame max + LongTask**
 是判断你“到底丝不丝滑”的最终裁判

------

## 六、一句经验总结（给你这个系统的）

> 对超大文档系统来说：
>  **DOM 数量只是表象，滚动帧最大耗时 + LongTask 才是王。**

如果你愿意，把你现在的：

- overscan 屏数
- 单段落 DOM 规模
- 动态高度方案

贴出来，我可以直接帮你算一个**“安全上限配置表”**。